name: emmit-deployment-check
run-name: App has remained unchanged
concurrency: emmit-deployment-check

on:
  workflow_dispatch:
  schedule:
    # Every 5 minutes
    - cron: "*/5 * * * *"

jobs:
  check-staging:
    environment: staging
    runs-on: ubuntu-latest
    steps:
    - name: Fetch website content
      run: |
        curl -si "https://tanzu-staging.academy" | grep last-modified > last-modified.txt
        cat last-modified.txt

    - name: See if this site content was previously seen
      id: restore
      uses: actions/cache/restore@v4
      with:
        path: last-modified.txt
        key: emmit-deployment-check-staging-${{ hashFiles('last-modified.txt') }}
        lookup-only: true

    - name: Save this version regardless
      id: save
      uses: actions/cache/save@v4
      with:
        path: last-modified.txt
        key: emmit-deployment-check-staging-${{ hashFiles('last-modified.txt') }}

    - name: Notify if data has changed (example using email)
      # This step only runs if there was not a cache hit (meaning the content changed)
      if: steps.save.outputs.cache-hit != 'true'
      # You would replace this with your preferred notification method (e.g., Slack webhook, email action)
      run: |
        echo "Deployment has happened $(curl -s -I -w '%header{last-modified}' https://tanzu-staging.academy -o /dev/null)"
        exit 1

  check-production:
    environment: production
    runs-on: ubuntu-latest
    steps:
    - name: Fetch website content
      run: |
        curl -si "https://tanzu.academy" | grep last-modified > last-modified.txt
        cat last-modified.txt

    - name: See if this site content was previously seen
      id: restore
      uses: actions/cache/restore@v4
      with:
        path: last-modified.txt
        key: emmit-deployment-check-production-${{ hashFiles('last-modified.txt') }}
        lookup-only: true

    - name: Save this version regardless
      id: save
      uses: actions/cache/save@v4
      with:
        path: index.html
        key: emmit-deployment-check-production-${{ hashFiles('last-modified.txt') }}

    - name: Notify if data has changed (example using email)
      # This step only runs if there was not a cache hit (meaning the content changed)
      if: steps.restore.outputs.cache-hit != 'true'
      # You would replace this with your preferred notification method (e.g., Slack webhook, email action)
      run: |
        echo "Deployment has happened $(curl -s -I -w '%header{last-modified}' https://tanzu.academy -o /dev/null)"
        exit 1
         
